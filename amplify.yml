version: 1
backend:
  phases:
    build:
      commands:
        - echo "Installing Python dependencies..."
        - python3 -m pip install --upgrade pip
        - python3 -m pip install virtualenv
        - python3 -m virtualenv venv
        - source venv/bin/activate
        - echo "Installing requirements from requirements.txt..."
        - if [ -f "requirements.txt" ]; then pip install -r requirements.txt; else echo "requirements.txt not found!" && exit 1; fi
    start:
      commands:
        - echo "Starting FastAPI server..."
        - cd /opt/
        - nohup uvicorn src.agents.api:app --host 0.0.0.0 --port 8000 --workers 4 &
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
      - requirements.txt
    exclude:
      - venv/**/*
      - node_modules/**/*

frontend:
  phases:
    preBuild:
      commands:
        - npm ci --verbose
    build:
      commands:
        - echo "Starting build..."
        - npm run build || { echo "Build failed"; exit 1; }
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*

# Add environment variables configuration
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'Cache-Control'
        value: 'no-cache'
      - key: 'X-Frame-Options'
        value: 'SAMEORIGIN'

# Add proxy configuration for the API
proxy:
  command: |
    echo "Setting up proxy for FastAPI backend..."
    cat > ./dist/config.json << EOF
    {
      "rewrites": [
        {
          "source": "/api/*",
          "destination": "http://localhost:8000/api/:splat"
        },
        {
          "source": "/health",
          "destination": "http://localhost:8000/health"
        }
      ]
    }
    EOF
