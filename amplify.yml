version: 1
backend:
  phases:
    build:
      commands:
        - echo "Installing Python dependencies..."
        - python3 -m pip install --upgrade pip
        - python3 -m pip install virtualenv
        - python3 -m virtualenv venv
        - source venv/bin/activate
        - echo "Current directory contents:"
        - ls -la
        - echo "Installing requirements from requirements.txt..."
        - if [ -f "requirements.txt" ]; then pip install -r requirements.txt; else echo "requirements.txt not found!" && exit 1; fi
        - echo "Starting FastAPI server..."
        - nohup uvicorn src.agents.api:app --host 0.0.0.0 --port 8000 &
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
      - requirements.txt
    exclude:
      - venv/**/*
      - node_modules/**/*

frontend:
  phases:
    preBuild:
      commands:
        - npm ci --verbose
        - npm list
    build:
      commands:
        - echo "Starting build..."
        - npm run build || { echo "Build failed"; exit 1; }
        - echo "Build completed"
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
    commands:
      - echo "Cache paths configured"

  # Add environment variables configuration
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-cache'
        - key: 'X-Frame-Options'
          value: 'SAMEORIGIN'

# Add proxy configuration for the API
proxy:
  command: |
    echo "Setting up proxy for FastAPI backend..."
    cat > ./dist/config.json << EOF
    {
      "rewrites": [
        {
          "source": "/api/:path*",
          "destination": "http://localhost:8000/api/:path*"
        },
        {
          "source": "/health",
          "destination": "http://localhost:8000/health"
        }
      ]
    }
    EOF
